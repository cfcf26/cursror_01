# 채팅 기능 테스트 가이드

## 테스트 전 준비사항

### 1. Supabase 프로젝트 설정
- Supabase 프로젝트가 생성되어 있어야 합니다
- 환경 변수 `.env.local`이 올바르게 설정되어 있어야 합니다:
  ```
  NEXT_PUBLIC_SUPABASE_URL=your-project-url
  NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
  ```

### 2. 데이터베이스 스키마 적용
`docs/supabase-schema.sql` 파일의 스키마가 Supabase 프로젝트에 적용되어 있어야 합니다.

### 3. Realtime 활성화
Supabase 대시보드에서 Realtime 기능이 활성화되어 있어야 합니다:
- Database > Replication으로 이동
- `chat_messages` 테이블에 대한 Realtime을 활성화

## 테스트 체크리스트

### A. 채팅방 목록 페이지 (`/chat`)

- [ ] **인증 확인**
  - 비로그인 상태에서 `/chat` 접속 시 로그인 페이지로 리다이렉트
  - 로그인 후 채팅 목록 페이지 정상 표시

- [ ] **채팅방 목록 조회**
  - 내가 buyer 또는 seller인 채팅방만 표시
  - 채팅방이 없을 때 "아직 채팅방이 없습니다." 메시지 표시
  - 채팅방 카드에 다음 정보 표시 확인:
    - 상품 제목
    - 상대방 이메일
    - 상품 가격 (원화 포맷)
    - 생성 날짜

- [ ] **UI 디자인**
  - 카드에 2px 테두리 (border-2)
  - 직각 모서리 (rounded 없음)
  - hover 시 배경색 변경 (hover:bg-gray-50)
  - 가격은 kiwi-500 컬러로 표시

### B. 채팅방 페이지 (`/chat/[roomId]`)

#### B-1. 페이지 접근 및 보안

- [ ] **권한 검증**
  - 채팅방 참여자가 아닌 사용자가 접근 시 `/chat`로 리다이렉트
  - 존재하지 않는 roomId로 접근 시 404 페이지 표시

- [ ] **채팅방 정보 표시**
  - 헤더에 상품 제목 표시
  - 상대방 이메일 표시 ("xxx 님과의 채팅")
  - 상품 가격 표시 (kiwi-500 컬러)

#### B-2. 메시지 목록

- [ ] **초기 메시지 로딩**
  - 기존 메시지가 시간 순으로 정렬되어 표시
  - 메시지가 없을 때 "메시지를 시작해보세요!" 표시

- [ ] **메시지 UI**
  - 내 메시지: 오른쪽 정렬, kiwi-500 배경, 흰색 텍스트
  - 상대방 메시지: 왼쪽 정렬, 흰색 배경, 검은색 텍스트
  - 모든 메시지에 2px 테두리
  - 직각 모서리
  - 시간 표시 (HH:MM 포맷)

- [ ] **메시지 내용 처리**
  - 긴 메시지 자동 줄바꿈 (break-words)
  - 개행문자 처리 (whitespace-pre-wrap)
  - 최대 너비 제한 (max-w-xs md:max-w-md)

- [ ] **자동 스크롤**
  - 새 메시지 추가 시 자동으로 맨 아래로 스크롤
  - 부드러운 스크롤 애니메이션 (behavior: 'smooth')

#### B-3. 메시지 입력 및 전송

- [ ] **입력 필드**
  - 텍스트 입력 가능
  - placeholder: "메시지를 입력하세요"
  - 전송 중일 때 입력 비활성화

- [ ] **전송 버튼**
  - 빈 메시지일 때 버튼 비활성화
  - 전송 중일 때 "전송 중..." 표시 및 버튼 비활성화
  - 정상 상태일 때 "전송" 표시

- [ ] **메시지 전송**
  - Enter 키 또는 전송 버튼으로 메시지 전송
  - 전송 성공 시 입력 필드 자동 초기화
  - 전송 실패 시 에러 메시지 표시 (alert)
  - 빈 메시지 전송 방지 (trim 처리)

- [ ] **전송 중복 방지**
  - 전송 중 Enter 키 또는 버튼 클릭 무시
  - 전송 완료 전까지 새 메시지 전송 불가

### C. Realtime 기능

#### C-1. 단일 브라우저 테스트

- [ ] **자신의 메시지**
  - 메시지 전송 시 즉시 화면에 추가
  - 서버에서 반환된 메시지 데이터 사용

#### C-2. 다중 브라우저/탭 테스트

이 테스트는 두 개의 다른 브라우저나 시크릿 모드를 사용하여 진행:

1. **브라우저 A**: 사용자 1로 로그인
2. **브라우저 B**: 사용자 2로 로그인
3. 두 사용자가 같은 채팅방에 접속

- [ ] **실시간 메시지 수신**
  - 브라우저 A에서 메시지 전송 시 브라우저 B에 즉시 표시
  - 브라우저 B에서 메시지 전송 시 브라우저 A에 즉시 표시
  - 메시지 순서가 올바르게 유지됨

- [ ] **자동 스크롤**
  - 상대방 메시지 수신 시 자동 스크롤
  - 스크롤이 최하단에 있을 때만 자동 스크롤

- [ ] **메시지 중복 방지**
  - 자신이 전송한 메시지가 Realtime으로 다시 수신되어도 중복 표시되지 않음

#### C-3. 채널 구독/해제

- [ ] **채널 구독**
  - 채팅방 진입 시 Realtime 채널 자동 구독
  - 올바른 채널명으로 구독 (`chat-room-${roomId}`)
  - 해당 채팅방의 메시지만 수신 (filter 적용)

- [ ] **채널 해제**
  - 채팅방 퇴장 시 (뒤로가기, 다른 페이지 이동) 채널 구독 해제
  - 메모리 누수 없음 (개발자 도구의 Network 탭에서 Realtime 연결 확인)

### D. 에러 처리

- [ ] **네트워크 에러**
  - Supabase 연결 실패 시 적절한 에러 메시지 표시
  - 채팅방 목록 조회 실패 시 "채팅방 목록을 불러올 수 없습니다." 표시

- [ ] **권한 에러**
  - 로그인 필요 시 로그인 페이지로 리다이렉트
  - 메시지 전송 권한 없을 시 에러 메시지 표시

- [ ] **입력 검증**
  - 빈 메시지 전송 시 "메시지를 입력해주세요." 에러 반환
  - 공백만 있는 메시지 전송 불가

### E. 성능 및 최적화

- [ ] **초기 로딩**
  - 채팅방 목록 빠르게 로드
  - 채팅방 페이지 및 메시지 빠르게 로드

- [ ] **Realtime 성능**
  - 메시지 전송 후 1초 이내에 상대방 화면에 표시
  - 네트워크 지연 시에도 UI가 멈추지 않음

- [ ] **메모리 관리**
  - 채널 구독 해제가 정상적으로 작동
  - 여러 채팅방을 오가도 메모리 누수 없음

## 디버깅 팁

### 1. Realtime 연결 확인
브라우저 개발자 도구 > Network 탭에서 WebSocket 연결 확인:
- `wss://` 로 시작하는 Supabase Realtime 연결이 있어야 함
- Status: 101 Switching Protocols

### 2. 채널 구독 확인
브라우저 콘솔에서 다음 코드로 채널 상태 확인:
```javascript
// ChatRoom 컴포넌트에 임시로 추가
console.log('Channel subscribed:', channel.state)
```

### 3. RLS 정책 확인
Supabase 대시보드에서 RLS 정책이 올바르게 설정되었는지 확인:
- `chat_rooms`: buyer_id 또는 seller_id가 자신인 경우만 조회 가능
- `chat_messages`: 해당 채팅방 참여자만 조회/작성 가능

### 4. 네트워크 에러 디버깅
```typescript
// 에러 로그 추가
console.error('Supabase error:', error)
console.log('Error details:', error.message, error.details)
```

## 테스트 시나리오 예시

### 시나리오 1: 새 채팅방 생성 및 대화
1. 사용자 A가 상품 상세 페이지에서 "채팅하기" 버튼 클릭
2. 채팅방 생성 후 채팅 페이지로 이동
3. 사용자 A가 "안녕하세요" 메시지 전송
4. 사용자 B가 채팅 목록에서 새 채팅방 확인
5. 사용자 B가 채팅방 진입하여 메시지 확인
6. 사용자 B가 "네, 안녕하세요!" 응답
7. 사용자 A의 화면에 실시간으로 응답 표시 확인

### 시나리오 2: 여러 메시지 연속 전송
1. 사용자 A가 메시지 3개 연속 전송
2. 모든 메시지가 순서대로 표시되는지 확인
3. 자동 스크롤이 정상 작동하는지 확인
4. 사용자 B의 화면에 모든 메시지가 순서대로 실시간 표시되는지 확인

### 시나리오 3: 긴 메시지 테스트
1. 100자 이상의 긴 메시지 작성
2. 메시지가 카드 너비를 넘지 않고 줄바꿈되는지 확인
3. 개행문자가 포함된 메시지 작성 (Enter 키 입력)
4. 개행이 올바르게 표시되는지 확인

## 알려진 제한사항

1. **이미지 미지원**: 텍스트 메시지만 지원 (MVP 범위)
2. **읽음 표시 없음**: 메시지 읽음/안읽음 상태 미구현
3. **알림 없음**: 푸시 알림이나 브라우저 알림 미구현
4. **메시지 수정/삭제 없음**: 전송된 메시지 수정 불가
5. **채팅방 나가기 없음**: 채팅방 삭제 기능 미구현

## 성공 기준

모든 테스트 체크리스트 항목이 통과되면 채팅 기능 구현이 완료된 것으로 간주합니다.

특히 다음 핵심 기능이 정상 작동해야 합니다:
- ✅ 채팅방 목록 조회 및 표시
- ✅ 채팅방 접근 권한 검증
- ✅ 메시지 전송 및 저장
- ✅ Realtime 메시지 수신
- ✅ 자동 스크롤
- ✅ 에러 처리

